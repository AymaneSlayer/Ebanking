<!DOCTYPE html>
<html lang="fr">
  
<head>
  
  <meta charset="UTF-8" />
  <title>Détails du compte - {{ compte.numero }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* ton CSS inchangé sauf .detail-row & .edit-btn repositionné */
    body { min-height: 100vh; background: radial-gradient(circle at 60% 40%, #95c6ff 0%, #f8fcff 70%) fixed; font-family: 'Segoe UI', Arial, sans-serif; }
    .main-content { margin-left: 250px; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 0 12px; transition: margin-left 0.3s; }
    @media (max-width: 768px) { .main-content { margin-left: 0 !important; padding-top: 80px;} }
    .glass-card { 
      background: rgba(255,255,255,0.70); 
      border-radius:20px; 
      box-shadow:0 12px 40px rgba(33,61,163,0.14); 
      border:1.5px solid rgba(90,125,255,0.09); 
      max-width:1000px; 
      width:100%; 
      padding:40px 38px 32px; 
      margin:48px 0; 
      animation:fadein 1.2s cubic-bezier(.2,.7,.6,1);
      overflow: hidden; /* Empêche le débordement */
      will-change: transform;
    }
    @keyframes fadein {0%{transform: translateY(60px) scale(0.96);opacity:0;}70%{opacity:.8;}100%{transform:translateY(0) scale(1);opacity:1;}}
    .big-title { font-weight:bold; font-size:1.4em; letter-spacing:1.5px; color:#174ea6; margin-bottom:8px; }
    .info-title { font-size:1.05em; color:#4a4d5a; margin-bottom:20px; }
    .detail-row { 
      display:flex; 
      align-items:center; 
      margin-bottom:14px; 
      gap:11px; 
      position:relative; 
      padding-right:40px;
      word-wrap: break-word; /* Permet la coupure des mots longs */
      overflow-wrap: break-word;
    }
    .detail-label { min-width:140px; color:#4a4d5a; font-weight:500; flex-shrink: 0; }
    .detail-value { 
      font-weight:500; 
      color:#1c3457; 
      position:relative; 
      width:100%; 
      overflow: hidden; /* Empêche le débordement */
      text-overflow: ellipsis; /* Ajoute des points de suspension si nécessaire */
    }
    .solde { font-size:1.22em; font-weight:bold; }
    .solde-positive { color:#229943; text-shadow:0 2px 10px #daf3e2; }
    .solde-negative { color:#d63e3e; text-shadow:0 2px 10px #ffd5d5; }
    .status-icon { font-size:1.5em; vertical-align:middle; margin-right:7px; }
    .check-green { color:#1fbb3a; }
    .cross-red { color:#d83131; }
    .card-info { color:#1e40af; font-size:1.18em; margin-right:5px; }
    .secure-code { letter-spacing:2.5px; font-family:monospace; background:#f4f5fb; border-radius:5px; padding:2px 8px; font-size:1em; margin-left:4px; }
    .edit-btn { display:none; position:absolute; right:5px; top:50%; transform:translateY(-50%); color:#247cff; background:none; border:none; padding:2px; cursor:pointer; font-size:1.2em; z-index:1; }
    .detail-row:hover .edit-btn { display:inline-block; }
    
    /* Section opérations avec conteneur fixe */
    .operations-section {
      margin-top: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.3);
      border-radius: 12px;
      border: 1px solid rgba(90,125,255,0.1);
    }
    
    .operations-container {
      max-height: 300px; /* Hauteur fixe pour éviter le débordement */
      overflow-y: auto; /* Scroll vertical si nécessaire */
      overflow-x: hidden; /* Pas de scroll horizontal */
      border-radius: 8px;
      background: rgba(255,255,255,0.2);
      padding: 10px;
    }
    
    .operation-list { 
      list-style:none; 
      padding-left:0; 
      margin-bottom:0;
    }
    .operation-list li { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      padding:11px 8px; 
      border-bottom:1px solid #f3f6fa; 
      font-size:1.05em;
      word-wrap: break-word;
      overflow-wrap: break-word;
      min-height: 45px; /* Hauteur minimale pour uniformiser */
    }
    .operation-list li:last-child { border-bottom:none; }
    
    /* Amélioration de la responsivité des opérations */
    .operation-date {
      color:#7d91b6; 
      min-width:90px;
      flex-shrink: 0;
    }
    
    .operation-type {
      min-width:70px;
      flex-shrink: 0;
    }
    
    .operation-amount {
      margin-left: auto;
      text-align: right;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .back-link { margin-top:30px; display:inline-flex; align-items:center; gap:6px; text-decoration:none; color:#2261bf; font-weight:500; border-radius:7px; transition:color 0.14s, background 0.13s; padding:8px 14px; background:linear-gradient(90deg,#eaf0fa 60%,#f5f8ff 100%); }
    .back-link:hover { color:#0a2d7a; background:#d4eaff; }
    .form-inline-edit { display:inline-flex; align-items:center; gap:7px; }
    .form-inline-edit input { font-size:1em; }
    
    .compte-infos-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 30px;
      margin-top: 20px;
    }

    .compte-info-item {
      background: rgba(255, 255, 255, 0.3);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 500;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .compte-details-container {
      width: 90%;
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.4);
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* Responsive pour mobile */
    @media (max-width: 768px) {
      .compte-infos-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .operation-list li {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .operation-date {
        min-width: 80px;
        font-size: 0.9em;
      }
      
      .operation-type {
        min-width: 60px;
      }
    }

  </style>
</head>
<body>
  {% include 'sidebar.html' %}
  <div class="main-content">
    <div class="glass-card shadow-lg">
      <div class="big-title">Compte n° {{ compte.numero }}</div>
      <div class="info-title">
        <i class="bi bi-person-fill"></i>
        Titulaire : <strong>{{ compte.client.prenom }} {{ compte.client.nom }}</strong>
      </div>
      <div class="info-title">
        <i class="bi bi-id-badge"></i>
        ClientID : <strong>{{ compte.client_id }}</strong>
      </div>

      <!-- Toutes tes detail-row inline comme avant -->
<!-- Boutons Éditer / Valider -->
<div style="margin-bottom: 20px; text-align: right;">
  <button id="btn-edit" class="btn btn-primary btn-sm">Éditer</button>
  <button id="btn-save" class="btn btn-success btn-sm" style="display:none;">Valider</button>
</div>

<!-- Grille des champs -->
<div class="compte-infos-grid">
  {% set champs = [
    ('type_carte', 'Type carte', 'select', ['Visa', 'MasterCard']),
    ('etat_carte', 'État carte', 'select', ['Actif', 'Inactif']),
    ('date_expiration_carte', 'Date expiration', 'date', None),
    ('code_securite', 'Code sécurité', 'text', None),
    ('solde', 'Solde', 'number', None),
    ('intitule', 'Intitulé', 'text', None),
    ('devise', 'Devise', 'text', None),
    ('date_creation', 'Date création', 'date', None),
    ('derniere_operation', 'Dernière opération', 'datetime-local', None),
    ('plafond', 'Plafond', 'number', None),
    ('autorise_decouvert', 'Découvert autorisé', 'select', ['True', 'False']),
    ('solde_minimum', 'Solde minimum', 'number', None),
    ('statut', 'Statut', 'text', None),
    ('banque_nom', 'Banque', 'text', None),
    ('iban', 'IBAN', 'text', None),
    ('pin_code', 'PIN', 'text', None),
    ('tentatives_pin', 'Tentatives PIN', 'number', None),
    ('bloque', 'Bloqué', 'select', ['True', 'False'])
  ] %}

  {% for field, label, input_type, options in champs %}
  <div class="detail-row">
    <span class="detail-label">{{ label }}:</span>
    <span class="detail-value">
      <span id="{{ field }}-text">
        {{ getattr(compte, field) }}
      </span>

      {% if input_type == 'select' %}
      <select id="input-{{ field }}" class="form-select form-select-sm" style="display:none; width:auto;">
        {% for option in options %}
        <option value="{{ option }}" {% if getattr(compte, field)|string == option %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
      {% else %}
      <input type="{{ input_type }}" id="input-{{ field }}" class="form-control form-control-sm" style="display:none; width:auto;"
             value="{{ getattr(compte, field) if getattr(compte, field) is not none else '' }}">
      {% endif %}
    </span>
  </div>
  {% endfor %}
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnEdit = document.getElementById('btn-edit');
  const btnSave = document.getElementById('btn-save');

  btnEdit.addEventListener('click', () => {
    document.querySelectorAll('[id^="input-"]').forEach(el => el.style.display = 'inline-block');
    document.querySelectorAll('[id$="-text"]').forEach(span => span.style.display = 'none');
    btnEdit.style.display = 'none';
    btnSave.style.display = 'inline-block';
  });

  btnSave.addEventListener('click', () => {
    const fields = [
      'type_carte','etat_carte','date_expiration_carte','code_securite','solde',
      'intitule','devise','date_creation','derniere_operation','plafond',
      'autorise_decouvert','solde_minimum','statut','banque_nom','iban',
      'pin_code','tentatives_pin','bloque'
    ];

    const payload = {};
    fields.forEach(field => {
      const el = document.getElementById(`input-${field}`);
      if (el) payload[field] = el.value;
    });

    fetch(`/compte/{{ compte.numero }}/update_all`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        fields.forEach(field => {
          const text = document.getElementById(`${field}-text`);
          if (text && payload[field] !== undefined) {
            text.textContent = payload[field];
          }
        });
        document.querySelectorAll('[id^="input-"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('[id$="-text"]').forEach(span => span.style.display = 'inline');
        btnEdit.style.display = 'inline-block';
        btnSave.style.display = 'none';
        alert('✅ Mise à jour réussie');
      } else {
        alert('❌ Erreur : ' + data.message);
      }
    })
    .catch(err => alert('❌ Erreur réseau : ' + err));
  });
});
</script>

